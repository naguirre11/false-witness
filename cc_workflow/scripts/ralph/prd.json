{
  "project": "False Witness",
  "branchName": "ralph/networking-voice",
  "description": "Steam integration and proximity-based voice chat system",
  "tickets": ["FW-013", "FW-014"],
  "userStories": [
    {
      "id": "FW-013-01",
      "title": "Install and configure GodotSteam plugin",
      "description": "Set up GodotSteam GDExtension in project",
      "acceptanceCriteria": [
        "GodotSteam plugin installed in addons/godotsteam/",
        "GDExtension configured in project.godot",
        "Steam app ID configured (use 480 for testing)",
        "Plugin loads without errors on startup",
        "$GODOT --headless --import succeeds",
        "gdlint src/ passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "GodotSteam already in addons/. App ID 480 is Spacewar (testing)."
    },
    {
      "id": "FW-013-02",
      "title": "Enhance SteamManager initialization",
      "description": "Update existing SteamManager with full Steam API init",
      "acceptanceCriteria": [
        "SteamManager calls Steam.steamInit() on _ready()",
        "Check Steam.isSteamRunning() before operations",
        "Store local Steam ID: Steam.getSteamID()",
        "Store local display name: Steam.getPersonaName()",
        "Emit steam_initialized signal on success",
        "Handle init failure gracefully",
        "gdlint src/ passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "File: src/core/steam_manager.gd already exists"
    },
    {
      "id": "FW-013-03",
      "title": "Implement Steam lobby creation",
      "description": "Create private Steam lobbies",
      "acceptanceCriteria": [
        "Add create_lobby(max_members: int) method to SteamManager",
        "Use Steam.createLobby(Steam.LOBBY_TYPE_FRIENDS_ONLY, max_members)",
        "Connect to lobby_created callback",
        "Generate 6-character lobby code from lobby ID",
        "Store lobby_id when created",
        "Emit lobby_created(lobby_id, code) signal",
        "gdlint src/ passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Private lobbies only per GDD (LOBBY_TYPE_FRIENDS_ONLY)"
    },
    {
      "id": "FW-013-04",
      "title": "Implement lobby code system",
      "description": "Generate and decode lobby codes",
      "acceptanceCriteria": [
        "Add _generate_lobby_code(lobby_id: int) -> String method",
        "Code is 6 alphanumeric characters",
        "Add _decode_lobby_code(code: String) -> int method",
        "Code encodes lobby ID reversibly",
        "Store code<->ID mapping for session",
        "gdlint src/ passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Base36 encoding of lobby ID works well for 6 chars"
    },
    {
      "id": "FW-013-05",
      "title": "Implement Steam lobby joining",
      "description": "Join lobby by code or direct ID",
      "acceptanceCriteria": [
        "Add join_lobby(code: String) method",
        "Decode code to lobby ID",
        "Call Steam.joinLobby(lobby_id)",
        "Connect to lobby_joined callback",
        "Emit lobby_joined(lobby_id) signal on success",
        "Emit lobby_join_failed(reason) on failure",
        "gdlint src/ passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Handle invalid codes gracefully"
    },
    {
      "id": "FW-013-06",
      "title": "Implement lobby member tracking",
      "description": "Track who is in the lobby",
      "acceptanceCriteria": [
        "Connect to lobby_chat_update callback for joins/leaves",
        "Maintain _lobby_members: Array[int] of Steam IDs",
        "Add get_lobby_members() -> Array method",
        "Add get_member_name(steam_id: int) -> String method",
        "Emit lobby_member_joined(steam_id) signal",
        "Emit lobby_member_left(steam_id) signal",
        "gdlint src/ passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Steam provides persona names for all members"
    },
    {
      "id": "FW-013-07",
      "title": "Implement lobby data sync",
      "description": "Sync game settings via lobby data",
      "acceptanceCriteria": [
        "Add set_lobby_data(key: String, value: String) method",
        "Add get_lobby_data(key: String) -> String method",
        "Sync host settings: map, max_players, game_mode",
        "Connect to lobby_data_update callback",
        "Emit lobby_data_changed(key, value) signal",
        "gdlint src/ passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Lobby data is key-value strings visible to all members"
    },
    {
      "id": "FW-013-08",
      "title": "Integrate Steam lobby with LobbyManager",
      "description": "Connect SteamManager to existing LobbyManager",
      "acceptanceCriteria": [
        "LobbyManager.create_lobby() calls SteamManager.create_lobby()",
        "LobbyManager.join_lobby() calls SteamManager.join_lobby()",
        "Steam lobby members map to LobbyManager slots",
        "Ready state synced via lobby member data",
        "Host determined by lobby owner",
        "gdlint src/ passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "LobbyManager is at src/core/lobby_manager.gd"
    },
    {
      "id": "FW-013-09",
      "title": "Implement Steam friend invite",
      "description": "Invite Steam friends to lobby",
      "acceptanceCriteria": [
        "Add invite_friend(steam_id: int) method",
        "Use Steam.inviteUserToLobby(lobby_id, steam_id)",
        "Steam overlay handles invite UI",
        "Invited players see invite notification",
        "Accept invite joins lobby automatically",
        "gdlint src/ passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Steam overlay provides invite picker UI"
    },
    {
      "id": "FW-013-10",
      "title": "Implement Steam Networking Sockets P2P",
      "description": "Use Steam relay for P2P connections",
      "acceptanceCriteria": [
        "Initialize Steam Networking Sockets API",
        "Add connect_to_player(steam_id: int) method",
        "Use Steam relay when direct P2P fails",
        "Handle connection state callbacks",
        "Emit peer_connected(steam_id) signal",
        "Emit peer_disconnected(steam_id) signal",
        "gdlint src/ passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Steam relay provides NAT traversal fallback. Using legacy P2P API with allowP2PPacketRelay(true)"
    },
    {
      "id": "FW-013-11",
      "title": "Integrate Steam P2P with NetworkManager",
      "description": "Use Steam networking as NetworkManager backend",
      "acceptanceCriteria": [
        "NetworkManager detects Steam availability",
        "When Steam available, use Steam P2P instead of ENet",
        "Peer IDs map to Steam IDs",
        "RPC calls route through Steam networking",
        "Fallback to ENet if Steam unavailable",
        "gdlint src/ passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "NetworkManager at src/core/network_manager.gd has dual backend. Already implemented."
    },
    {
      "id": "FW-013-12",
      "title": "Implement Steam Rich Presence",
      "description": "Show game state in Steam friends list",
      "acceptanceCriteria": [
        "Add update_rich_presence(state: String) method",
        "Update presence when game state changes",
        "Show: 'In Lobby (4/6)', 'Investigating', 'In Hunt', etc.",
        "Friends can see current status",
        "'Join Game' button appears for friends",
        "gdlint src/ passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Uses Steam.setRichPresence()"
    },
    {
      "id": "FW-013-13",
      "title": "Handle join requests from friends list",
      "description": "Process 'Join Game' requests",
      "acceptanceCriteria": [
        "Connect to join_requested callback",
        "Extract lobby ID from join request",
        "Auto-join lobby when request received",
        "Handle case when lobby is full",
        "Handle case when game already in progress",
        "gdlint src/ passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Friends click 'Join Game' in Steam overlay"
    },
    {
      "id": "FW-013-14",
      "title": "Implement graceful Steam fallback",
      "description": "Work without Steam for development/LAN",
      "acceptanceCriteria": [
        "Check Steam.isSteamRunning() on init",
        "If Steam unavailable, use ENet-only mode",
        "LobbyManager works with manual IP entry",
        "Log warning about limited functionality",
        "All game features work without Steam (except friends)",
        "gdlint src/ passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Important for development and testing"
    },
    {
      "id": "FW-013-15",
      "title": "Write integration tests for Steam lobby",
      "description": "Test Steam lobby functionality",
      "acceptanceCriteria": [
        "Create tests/integration/test_steam_lobby.gd",
        "Test lobby code generation and decoding",
        "Test lobby data sync",
        "Test fallback behavior when Steam unavailable",
        "Mock Steam API for testing",
        "All tests pass",
        "gdlint tests/ passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "File: tests/integration/test_steam_lobby.gd"
    },
    {
      "id": "FW-014-01",
      "title": "Create VoiceManager autoload",
      "description": "Central manager for voice chat",
      "acceptanceCriteria": [
        "Create src/voice/voice_manager.gd extending Node",
        "Register as autoload VoiceManager in project.godot",
        "Add is_voice_enabled: bool property",
        "Add local_muted: bool property",
        "Add voice_mode: VoiceMode enum (PUSH_TO_TALK, OPEN_MIC)",
        "Emit voice_state_changed signal",
        "$GODOT --headless --import succeeds",
        "gdlint src/ passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "File: src/voice/voice_manager.gd"
    },
    {
      "id": "FW-014-02",
      "title": "Create VoiceMode and VoiceState enums",
      "description": "Define voice chat modes and states",
      "acceptanceCriteria": [
        "Create src/voice/voice_enums.gd with class_name VoiceEnums",
        "Add VoiceMode enum: PUSH_TO_TALK, OPEN_MIC, DISABLED",
        "Add VoiceState enum: IDLE, TRANSMITTING, RECEIVING",
        "Add default key binding for push-to-talk (V key)",
        "gdlint src/ passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "File: src/voice/voice_enums.gd"
    },
    {
      "id": "FW-014-03",
      "title": "Initialize Steam Voice API",
      "description": "Set up Steam voice recording",
      "acceptanceCriteria": [
        "Call Steam.startVoiceRecording() when voice enabled",
        "Call Steam.stopVoiceRecording() when disabled",
        "Set voice sample rate to optimal value",
        "Handle voice initialization errors",
        "gdlint src/ passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Uses GodotSteam voice functions. Runtime API check for compatibility."
    },
    {
      "id": "FW-014-04",
      "title": "Implement microphone input capture",
      "description": "Capture voice from local microphone",
      "acceptanceCriteria": [
        "Poll Steam.getAvailableVoice() in _process",
        "When voice available, call Steam.getVoice()",
        "Store voice data in buffer",
        "Emit voice_data_captured(data: PackedByteArray) signal",
        "gdlint src/ passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Steam handles audio capture and compression"
    },
    {
      "id": "FW-014-05",
      "title": "Implement push-to-talk mode",
      "description": "Voice transmits only when key held",
      "acceptanceCriteria": [
        "Add 'voice_transmit' input action (default: V key)",
        "Start voice recording when key pressed",
        "Stop voice recording when key released",
        "Show transmitting indicator in UI",
        "gdlint src/ passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Recommended default for horror games. UI indicator handled in HUD."
    },
    {
      "id": "FW-014-06",
      "title": "Implement open mic mode with voice activity detection",
      "description": "Voice transmits automatically when speaking",
      "acceptanceCriteria": [
        "Monitor voice amplitude continuously",
        "Start transmitting when amplitude exceeds threshold",
        "Stop transmitting after silence period (300ms)",
        "Configurable sensitivity threshold",
        "Show voice activity indicator in UI",
        "gdlint src/ passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Alternative to push-to-talk for accessibility"
    },
    {
      "id": "FW-014-07",
      "title": "Send voice data over network",
      "description": "Transmit voice to other players",
      "acceptanceCriteria": [
        "Package voice data with sender ID and timestamp",
        "Send via unreliable channel (UDP-like) for low latency",
        "Use Steam Networking Messages API",
        "Broadcast to all peers in range",
        "gdlint src/ passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Voice data is lossy-tolerant; prefer low latency"
    },
    {
      "id": "FW-014-08",
      "title": "Receive and decode voice data",
      "description": "Process incoming voice from other players",
      "acceptanceCriteria": [
        "Listen for incoming voice packets",
        "Identify sender by Steam ID",
        "Decompress voice data with Steam.decompressVoice()",
        "Buffer decoded audio for playback",
        "Handle out-of-order packets",
        "gdlint src/ passes"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Steam provides decompression"
    },
    {
      "id": "FW-014-09",
      "title": "Create VoicePlayer component for spatial audio",
      "description": "3D audio playback per remote player",
      "acceptanceCriteria": [
        "Create src/voice/voice_player.gd extending AudioStreamPlayer3D",
        "Attach to player Node3D",
        "Stream voice data to AudioStreamGenerator",
        "Position updates with player movement",
        "Configure attenuation for proximity effect",
        "gdlint src/ passes"
      ],
      "priority": 24,
      "passes": true,
      "notes": "File: src/voice/voice_player.gd"
    },
    {
      "id": "FW-014-10",
      "title": "Implement voice proximity falloff",
      "description": "Voice fades with distance",
      "acceptanceCriteria": [
        "Configure AudioStreamPlayer3D max_distance (default: 15m)",
        "Set attenuation_model to INVERSE_DISTANCE",
        "Voice inaudible beyond max_distance",
        "Configurable falloff curve",
        "Test falloff feels natural",
        "gdlint src/ passes"
      ],
      "priority": 25,
      "passes": true,
      "notes": "Core horror mechanic: nearby voices only"
    },
    {
      "id": "FW-014-11",
      "title": "Implement per-player mute",
      "description": "Mute/unmute individual players",
      "acceptanceCriteria": [
        "Add mute_player(steam_id: int) method",
        "Add unmute_player(steam_id: int) method",
        "Add is_player_muted(steam_id: int) -> bool method",
        "Muted players' audio not played locally",
        "Store mute state persistently",
        "gdlint src/ passes"
      ],
      "priority": 26,
      "passes": true,
      "notes": "Important for player comfort. Already implemented in VoiceManager."
    },
    {
      "id": "FW-014-12",
      "title": "Create voice volume indicator UI",
      "description": "Visual feedback for voice activity",
      "acceptanceCriteria": [
        "Show microphone icon when transmitting (already in HUD)",
        "Icon pulses/grows with voice amplitude",
        "Show speaker icons near players who are talking",
        "Speaker icon size indicates volume level",
        "gdlint src/ passes"
      ],
      "priority": 27,
      "passes": true,
      "notes": "HUD connects to VoiceManager.voice_state_changed. Mic icon pulses with sine wave animation. PlayerNameLabel3D shows speaker icon above talking players via voice_activity signal."
    },
    {
      "id": "FW-014-13",
      "title": "Expose voice activity for entity detection",
      "description": "Signal for entity AI to detect noisy players",
      "acceptanceCriteria": [
        "Add get_voice_amplitude() -> float method",
        "Add is_transmitting() -> bool method",
        "Emit voice_activity(player_id, amplitude) signal",
        "Entity system can subscribe to detect loud players",
        "gdlint src/ passes"
      ],
      "priority": 28,
      "passes": true,
      "notes": "Used by Listener entity and hunt mechanics. voice_activity signal implemented."
    },
    {
      "id": "FW-014-14",
      "title": "Implement voice latency optimization",
      "description": "Minimize voice delay to <200ms",
      "acceptanceCriteria": [
        "Measure round-trip voice latency",
        "Use jitter buffer for smooth playback",
        "Adaptive buffer size based on network conditions",
        "Target latency under 200ms",
        "Log latency metrics for debugging",
        "gdlint src/ passes"
      ],
      "priority": 29,
      "passes": false,
      "notes": "Latency target per ticket: <200ms"
    },
    {
      "id": "FW-014-15",
      "title": "Add voice settings to game settings",
      "description": "User configuration for voice chat",
      "acceptanceCriteria": [
        "Add voice_mode setting (push-to-talk/open-mic/disabled)",
        "Add voice_sensitivity setting for VAD threshold",
        "Add voice_input_volume setting",
        "Add voice_output_volume setting",
        "Settings persist to config file",
        "gdlint src/ passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": "Settings accessible from main menu"
    },
    {
      "id": "FW-014-16",
      "title": "Write integration tests for voice system",
      "description": "Test voice chat functionality",
      "acceptanceCriteria": [
        "Create tests/integration/test_voice_manager.gd",
        "Test push-to-talk activation",
        "Test voice activity detection",
        "Test mute/unmute functionality",
        "Test spatial audio positioning",
        "Mock audio input for testing",
        "All tests pass",
        "gdlint tests/ passes"
      ],
      "priority": 31,
      "passes": false,
      "notes": "File: tests/integration/test_voice_manager.gd"
    }
  ]
}
